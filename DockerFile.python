# For Python environment
FROM python:alpine

WORKDIR /workdir

RUN apk add bash npm file curl git ripgrep jq util-linux
RUN npm i -g @openai/codex 

RUN addgroup -S codex && adduser -S codex -G codex && \
    mkdir -p /home/codex/.codex /workdir && \
    chown -R codex:codex /home/codex /workdir

COPY --chown=codex:codex config.toml /home/codex/.codex/

# Configure git
RUN su -s /bin/sh -c "git config --global user.email \"codex@localhost\" && \
    git config --global user.name \"Codex CLI\" && \
    git config --global init.defaultBranch \"main\"" codex

ENV HOME=/home/codex USER=codex
USER codex

ENTRYPOINT ["setpriv","--inh-caps=-all","--ambient-caps=-all","--bounding-set=-all","--no-new-privs","--"]
CMD ["codex","--profile","gpt-oss"]
