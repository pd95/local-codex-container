# For Python environment
FROM python:alpine

WORKDIR /workdir

RUN apk add bash npm file curl git ripgrep jq util-linux
RUN npm i -g @openai/codex 

RUN addgroup -S coder && adduser -S coder -G coder && \
    mkdir -p /home/coder/.codex /workdir && \
    chown -R coder:coder /home/coder /workdir

COPY --chown=coder:coder config.toml /home/coder/.codex/

# Configure git
RUN su -s /bin/sh -c "git config --global user.email \"codex@localhost\" && \
    git config --global user.name \"Codex CLI\" && \
    git config --global init.defaultBranch \"main\"" coder

ENV HOME=/home/coder USER=coder
USER coder

ENTRYPOINT ["setpriv","--inh-caps=-all","--ambient-caps=-all","--bounding-set=-all","--no-new-privs","--"]
CMD ["codex","--profile","gpt-oss"]
