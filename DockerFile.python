# For Python environment
FROM codex

USER root

# --- Python runtime & packaging ---
RUN apk add --no-cache \
    python3 py3-pip py3-setuptools py3-wheel

# --- Create a writable venv for coder ---
ENV VIRTUAL_ENV=/opt/venv
RUN python3 -m venv --system-site-packages "$VIRTUAL_ENV" \
 && "$VIRTUAL_ENV/bin/python" -m pip install --no-cache-dir -U pip setuptools wheel \
 && chown -R coder:coder "$VIRTUAL_ENV"

# Ensure login shells keep the venv on PATH
RUN printf '%s\n' \
  'export VIRTUAL_ENV=/opt/venv' \
  'export PATH="/opt/venv/bin:$PATH"' \
  > /etc/profile.d/venv.sh

# Ensure venv is the default python/pip for all processes (including Codex runs)
ENV PATH="$VIRTUAL_ENV/bin:$PATH" \
    PIP_DISABLE_PIP_VERSION_CHECK=1

USER coder
WORKDIR /workdir
