# For pure JS environment
FROM alpine:latest

# --- Core tooling ---
RUN apk add --no-cache \
        bash npm file curl git ripgrep jq util-linux

# --- Codex CLI ---
RUN npm install -g @openai/codex \
    --omit=dev \
    --no-fund \
    --no-audit \
    && npm cache clean --force

# --- Add user ---
RUN addgroup -S coder \
 && adduser  -S -G coder -h /home/coder -s /bin/bash coder \
 && mkdir -p /home/coder/.codex /workdir \
 && chown -R coder:coder /home/coder /workdir

# Make sure HOME is correct for subsequent RUNs when we switch user
ENV HOME=/home/coder

# Copy Codex default configuration
COPY --chown=coder:coder config.toml /home/coder/.codex/

# From here on, run as coder so swiftly writes user-owned files
USER coder
WORKDIR /workdir

# Configure git
RUN git config --global user.email "codex@localhost" \
 && git config --global user.name "Codex CLI" \
 && git config --global init.defaultBranch "main" \
 && git config --global --add safe.directory /workdir

# Hardened entrypoint
ENTRYPOINT ["setpriv","--inh-caps=-all","--ambient-caps=-all","--bounding-set=-all","--no-new-privs","--"]
CMD ["codex","--profile","gpt-oss"]
