FROM codex-python

USER root

# --- Office tooling and Python libs ---
RUN apk add --no-cache \
    ca-certificates openssh-client \
    fd \
    build-base python3-dev musl-dev \
    fontconfig ttf-dejavu \
    freetype libpng jpeg zlib \
    py3-numpy py3-pandas py3-matplotlib \
    py3-pypdf py3-pdfminer \
    py3-reportlab py3-pillow py3-openpyxl py3-xlsxwriter

# --- PPTX generator ---
RUN npm install -g pptxgenjs \
    --omit=dev \
    --no-fund \
    --no-audit \
    && npm cache clean --force

# Ensure global node modules resolve in scripts
ENV NODE_PATH=/usr/lib/node_modules:/usr/local/lib/node_modules
RUN printf '%s\n' \
  'export NODE_PATH=/usr/lib/node_modules:/usr/local/lib/node_modules' \
  > /etc/profile.d/node_path.sh

# Baseline extra pip packages you want available
RUN "$VIRTUAL_ENV/bin/pip" install --no-cache-dir \
    python-docx pytest xlrd \
 && chown -R coder:coder "$VIRTUAL_ENV"

USER coder
WORKDIR /workdir
