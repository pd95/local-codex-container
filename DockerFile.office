FROM alpine:latest

# --- Core tooling with Python and Office tools---
RUN apk add --no-cache \
    bash ca-certificates curl git openssh-client \
    ripgrep jq fd \
    file util-linux \
    nodejs npm \
    python3 py3-pip py3-setuptools py3-wheel \
    build-base python3-dev musl-dev \
    fontconfig ttf-dejavu \
    freetype libpng jpeg zlib \
    py3-numpy py3-pandas py3-matplotlib \
    py3-pypdf py3-pdfminer \
    py3-reportlab py3-pillow py3-openpyxl py3-xlsxwriter

# --- Codex CLI & PPTX generator ---
RUN npm install -g @openai/codex pptxgenjs \
    --omit=dev \
    --no-fund \
    --no-audit \
    && npm cache clean --force

# --- Create a writable venv for coder ---
ENV VIRTUAL_ENV=/opt/venv
RUN python3 -m venv --system-site-packages $VIRTUAL_ENV \
 && "$VIRTUAL_ENV/bin/python" -m pip install --no-cache-dir -U pip setuptools wheel

# Baseline extra pip packages you want available
RUN "$VIRTUAL_ENV/bin/pip" install --no-cache-dir \
    python-docx pytest xlrd

# --- Add user ---
RUN addgroup -S coder \
 && adduser  -S -G coder -h /home/coder -s /bin/bash coder \
 && mkdir -p /home/coder/.codex /workdir \
 && chown -R coder:coder /home/coder /workdir \
 && chown -R coder:coder "$VIRTUAL_ENV"

# Ensure venv is the default python/pip for all processes (including Codex runs)
ENV PATH="$VIRTUAL_ENV/bin:$PATH" \
    HOME=/home/coder \
    PIP_DISABLE_PIP_VERSION_CHECK=1

#ENV NODE_PATH=/usr/lib/node_modules

# Copy Codex default configuration
COPY --chown=coder:coder config.toml /home/coder/.codex/

# From here on, run as coder so swiftly writes user-owned files
USER coder
WORKDIR /workdir

# Configure git
RUN git config --global user.email "codex@localhost" \
 && git config --global user.name "Codex CLI" \
 && git config --global init.defaultBranch "main" \
 && git config --global --add safe.directory /workdir

# Hardened entrypoint
ENTRYPOINT [ "setpriv","--inh-caps=-all","--ambient-caps=-all","--bounding-set=-all","--no-new-privs","--"]
CMD ["codex","--profile","gpt-oss"]
